<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clinical Communication Simulator - Realistic Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #2c5f7c;
      --primary-dark: #1a3d52;
      --accent: #d4a574;
      --bg: #f8f6f3;
      --card-bg: #ffffff;
      --text: #2a2a2a;
      --text-light: #6b6b6b;
      --border: #e1ddd6;
      --success: #5c8f6a;
      --warning: #c47d4f;
      --critical: #c45d5d;
      --family: #7c8fa3;
      --action: #6a8c9f;
      --provider: #8b6a9f;
    }

    body {
      font-family: 'Work Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 3rem;
      padding: 2rem 0;
      border-bottom: 2px solid var(--border);
    }

    h1 {
      font-family: 'Crimson Pro', serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-dark);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      font-size: 1.1rem;
      color: var(--text-light);
      font-weight: 400;
    }

    /* Scenario Selection */
    .category-filters {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .filter-btn {
      padding: 0.75rem 1.5rem;
      border: 2px solid var(--border);
      background: var(--card-bg);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text);
    }

    .filter-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .scenario-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .scenario-card {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .scenario-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--accent);
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }

    .scenario-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(44, 95, 124, 0.1);
    }

    .scenario-card:hover::before {
      transform: scaleY(1);
    }

    .scenario-card.hidden {
      display: none;
    }

    .scenario-card h3 {
      font-family: 'Crimson Pro', serif;
      font-size: 1.4rem;
      color: var(--primary-dark);
      margin-bottom: 0.5rem;
    }

    .scenario-tags {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .scenario-tag {
      display: inline-block;
      background: var(--accent);
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .scenario-tag.critical {
      background: var(--critical);
    }

    .scenario-tag.family {
      background: var(--family);
    }

    .scenario-tag.sensitive {
      background: #9f6a6a;
    }

    .scenario-description {
      color: var(--text-light);
      font-size: 0.9rem;
      line-height: 1.6;
    }

    /* Simulation Interface */
    .simulation-container {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .simulation-container.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .alert-banner {
      background: var(--critical);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 6px;
      margin-bottom: 1.5rem;
      font-weight: 500;
      display: none;
      align-items: center;
      gap: 0.75rem;
      animation: pulse 2s ease-in-out infinite;
    }

    .alert-banner.active {
      display: flex;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    .main-layout {
      display: grid;
      grid-template-columns: 300px 1fr 350px;
      gap: 1.5rem;
    }

    /* MAR Sidebar */
    .mar-sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .mar-panel {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
    }

    .mar-panel h3 {
      font-family: 'Crimson Pro', serif;
      font-size: 1.2rem;
      color: var(--primary-dark);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border);
    }

    .vital-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
      background: #f9f8f6;
      border-radius: 4px;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .vital-item.abnormal {
      background: rgba(196, 93, 93, 0.1);
      border-left: 3px solid var(--critical);
    }

    .vital-label {
      font-weight: 500;
    }

    .vital-value {
      font-weight: 600;
      color: var(--primary);
    }

    .vital-item.abnormal .vital-value {
      color: var(--critical);
    }

    .medication-item {
      padding: 0.75rem;
      background: #f9f8f6;
      border-radius: 4px;
      margin-bottom: 0.75rem;
      border-left: 3px solid var(--accent);
    }

    .med-name {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .med-details {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    .med-indication {
      font-size: 0.8rem;
      color: var(--primary);
      font-style: italic;
      margin-top: 0.25rem;
    }

    .allergy-item {
      padding: 0.5rem;
      background: rgba(196, 93, 93, 0.1);
      border: 1px solid var(--critical);
      border-radius: 4px;
      color: var(--critical);
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .mar-item {
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .mar-label {
      font-weight: 600;
      color: var(--text-light);
      font-size: 0.8rem;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .mar-value {
      color: var(--text);
      padding: 0.5rem;
      background: #f9f8f6;
      border-radius: 4px;
    }

    .documentation-area {
      margin-top: 1rem;
    }

    .doc-textarea {
      width: 100%;
      min-height: 100px;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.85rem;
      resize: vertical;
    }

    .save-doc-btn {
      margin-top: 0.5rem;
      width: 100%;
      padding: 0.5rem;
      background: var(--success);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Center Content */
    .center-content {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .patient-info {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 8px;
    }

    .patient-info h2 {
      font-family: 'Crimson Pro', serif;
      font-size: 1.8rem;
      margin-bottom: 0.75rem;
    }

    .patient-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
      font-size: 0.9rem;
      opacity: 0.95;
    }

    .detail-label {
      font-weight: 600;
      opacity: 0.85;
    }

    /* Unified Room Communication */
    .room-container {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      height: 500px;
    }

    .room-header {
      padding: 1rem 1.5rem;
      border-bottom: 2px solid var(--border);
      font-weight: 600;
      background: #fafaf8;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .room-icon {
      font-size: 1.2rem;
    }

    .room-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      scroll-behavior: smooth;
    }

    .message {
      margin-bottom: 1.5rem;
      animation: messageSlide 0.3s ease;
    }

    @keyframes messageSlide {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .message.student {
      text-align: right;
    }

    .message-label {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text-light);
    }

    .message-label.patient {
      color: var(--primary);
    }

    .message-label.family {
      color: var(--family);
    }

    .message-label.action {
      color: var(--action);
      font-style: italic;
    }

    .message-bubble {
      display: inline-block;
      max-width: 85%;
      padding: 1rem 1.25rem;
      border-radius: 12px;
      background: #f0ede8;
      color: var(--text);
      text-align: left;
      line-height: 1.5;
    }

    .message.student .message-bubble {
      background: var(--primary);
      color: white;
      margin-left: auto;
    }

    .message.family .message-bubble {
      background: rgba(124, 143, 163, 0.15);
      border-left: 3px solid var(--family);
    }

    .message.action .message-bubble {
      background: rgba(106, 140, 159, 0.1);
      border-left: 3px solid var(--action);
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }

    .message.action-critical .message-bubble {
      background: rgba(196, 93, 93, 0.1);
      border-left: 3px solid var(--critical);
    }

    .room-input-container {
      border-top: 2px solid var(--border);
      padding: 1rem;
      background: #fafaf8;
    }

    .typing-indicator {
      display: none;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-light);
      font-style: italic;
      padding: 0.25rem 0;
      font-size: 0.85rem;
    }

    .typing-indicator.active {
      display: flex;
    }

    .typing-dots {
      display: flex;
      gap: 3px;
    }

    .typing-dots span {
      width: 5px;
      height: 5px;
      background: var(--text-light);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-3px); }
    }

    .input-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .input-tab {
      padding: 0.5rem 1rem;
      border: 2px solid var(--border);
      border-radius: 6px 6px 0 0;
      background: #f9f8f6;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .input-tab.active {
      background: white;
      border-bottom-color: white;
      color: var(--primary);
    }

    .input-tab.action-tab.active {
      color: var(--action);
    }

    .input-tab.provider-tab.active {
      color: var(--provider);
    }

    .input-content {
      display: none;
    }

    .input-content.active {
      display: block;
    }

    .room-input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.95rem;
      resize: vertical;
      min-height: 60px;
    }

    .input-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
      justify-content: flex-end;
    }

    .btn {
      padding: 0.6rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-family: 'Work Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-action {
      background: var(--action);
      color: white;
    }

    .btn-provider {
      background: var(--provider);
      color: white;
    }

    .btn-secondary {
      background: transparent;
      color: var(--text-light);
      border: 2px solid var(--border);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Provider Communication Modal */
    .provider-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .provider-modal.active {
      display: flex;
    }

    .provider-content {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .provider-content h3 {
      font-family: 'Crimson Pro', serif;
      font-size: 1.6rem;
      color: var(--provider);
      margin-bottom: 1.5rem;
    }

    .provider-messages {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f9f8f6;
      border-radius: 6px;
    }

    .provider-response {
      background: rgba(139, 106, 159, 0.1);
      padding: 1rem;
      border-radius: 6px;
      border-left: 3px solid var(--provider);
      margin-bottom: 1rem;
    }

    /* Right Sidebar */
    .right-sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .info-panel {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
    }

    .info-panel h3 {
      font-family: 'Crimson Pro', serif;
      font-size: 1.3rem;
      color: var(--primary-dark);
      margin-bottom: 1rem;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.5s ease;
    }

    .score-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      padding: 0.5rem;
      background: #f9f8f6;
      border-radius: 4px;
    }

    .score-label {
      font-weight: 500;
      font-size: 0.9rem;
    }

    .score-value {
      font-weight: 600;
      color: var(--primary);
    }

    /* Results Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--card-bg);
      padding: 3rem;
      border-radius: 12px;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-content h2 {
      font-family: 'Crimson Pro', serif;
      font-size: 2.2rem;
      color: var(--primary-dark);
      margin-bottom: 1.5rem;
    }

    .final-score {
      text-align: center;
      padding: 2rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-radius: 8px;
      margin-bottom: 2rem;
    }

    .final-score h3 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .performance-section {
      margin-bottom: 2rem;
    }

    .performance-section h4 {
      font-size: 1.2rem;
      color: var(--primary-dark);
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .feedback-item {
      padding: 1rem;
      background: #f9f8f6;
      border-radius: 6px;
      margin-bottom: 0.75rem;
      border-left: 4px solid var(--border);
    }

    .feedback-item.strength {
      border-left-color: var(--success);
    }

    .feedback-item.area-for-improvement {
      border-left-color: var(--warning);
    }

    .feedback-item.critical-miss {
      border-left-color: var(--critical);
    }

    .hidden {
      display: none;
    }

    @media (max-width: 1400px) {
      .main-layout {
        grid-template-columns: 250px 1fr 300px;
      }
    }

    @media (max-width: 1200px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Clinical Communication Simulator</h1>
      <p class="subtitle">Realistic nursing scenarios with integrated patient room dynamics</p>
    </header>

    <!-- Scenario Selection -->
    <div id="scenarioSelection">
      <div class="category-filters">
        <button class="filter-btn active" onclick="filterScenarios('all')">All Scenarios</button>
        <button class="filter-btn" onclick="filterScenarios('pediatric')">Pediatrics</button>
        <button class="filter-btn" onclick="filterScenarios('cardiac')">Cardiac</button>
        <button class="filter-btn" onclick="filterScenarios('abuse')">Sensitive/Abuse</button>
        <button class="filter-btn" onclick="filterScenarios('critical')">Critical</button>
      </div>

      <div class="scenario-grid" id="scenarioGrid"></div>
    </div>

    <!-- Simulation Interface -->
    <div id="simulationContainer" class="simulation-container">
      <div class="top-bar">
        <button class="btn btn-secondary" onclick="returnToScenarios()">‚Üê Back to Scenarios</button>
        <button class="btn btn-primary" onclick="endSession()">End Session</button>
      </div>

      <div id="alertBanner" class="alert-banner">
        <span class="alert-icon">‚ö†Ô∏è</span>
        <div id="alertText"></div>
      </div>

      <div class="patient-info" id="patientInfo"></div>

      <div class="main-layout">
        <!-- MAR Sidebar -->
        <div class="mar-sidebar">
          <div class="mar-panel">
            <h3>üìã MAR</h3>
            <div class="mar-item">
              <div class="mar-label">Current Vitals</div>
              <div id="currentVitals"></div>
            </div>
            <div class="mar-item">
              <div class="mar-label">Baseline Vitals</div>
              <div id="baselineVitals"></div>
            </div>
          </div>

          <div class="mar-panel">
            <h3>üíä Medications</h3>
            <div id="medicationsList"></div>
          </div>

          <div class="mar-panel">
            <h3>üö´ Allergies</h3>
            <div id="allergiesList"></div>
          </div>

          <div class="mar-panel">
            <h3>üìù History</h3>
            <div id="medicalHistory"></div>
          </div>

          <div class="mar-panel">
            <h3>‚úèÔ∏è Documentation</h3>
            <div class="documentation-area">
              <textarea id="nurseDocumentation" class="doc-textarea" placeholder="Document assessment, interventions, patient response..."></textarea>
              <button class="save-doc-btn" onclick="saveDocumentation()">Save Note</button>
            </div>
          </div>
        </div>

        <!-- Patient Room (Center) -->
        <div class="center-content">
          <div class="room-container">
            <div class="room-header">
              <span class="room-icon">üè•</span>
              <span>Patient Room - All Communication</span>
            </div>
            <div class="room-messages" id="roomMessages"></div>
            <div class="room-input-container">
              <div class="typing-indicator" id="roomTyping">
                <span id="typingName">Responding</span>
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
              
              <div class="input-tabs">
                <div class="input-tab active" onclick="switchTab('speak')">üí¨ Speak in Room</div>
                <div class="input-tab action-tab" onclick="switchTab('action')">‚öïÔ∏è Perform Action</div>
                <div class="input-tab provider-tab" onclick="switchTab('provider')">üìû Contact Provider</div>
              </div>

              <div id="speakContent" class="input-content active">
                <textarea id="speakInput" class="room-input" placeholder="Speak to patient/family in the room..." onkeydown="handleKeyPress(event, 'speak')"></textarea>
                <div class="input-actions">
                  <button class="btn btn-primary" onclick="sendMessage()">Speak</button>
                </div>
              </div>

              <div id="actionContent" class="input-content">
                <textarea id="actionInput" class="room-input" placeholder="Type action (e.g., 'Check vital signs', 'Administer morphine 2mg IV', 'Apply oxygen 2L NC')..." onkeydown="handleKeyPress(event, 'action')"></textarea>
                <div class="input-actions">
                  <button class="btn btn-action" onclick="performAction()">Perform Action</button>
                </div>
              </div>

              <div id="providerContent" class="input-content">
                <textarea id="providerInput" class="room-input" placeholder="Call provider with SBAR communication..." onkeydown="handleKeyPress(event, 'provider')"></textarea>
                <div class="input-actions">
                  <button class="btn btn-provider" onclick="callProvider()">Call Provider</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Sidebar -->
        <div class="right-sidebar">
          <div class="info-panel">
            <h3>Performance</h3>
            <div class="score-item">
              <span class="score-label">Communication</span>
              <span class="score-value" id="commScore">50/100</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="commProgress" style="width: 50%"></div>
            </div>
            <div class="score-item" style="margin-top: 1rem;">
              <span class="score-label">Clinical Judgment</span>
              <span class="score-value" id="techniqueScore">50/100</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="techniqueProgress" style="width: 50%"></div>
            </div>
            <div class="score-item" style="margin-top: 1rem;">
              <span class="score-label">Patient Care</span>
              <span class="score-value" id="satisfactionScore">50/100</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="satisfactionProgress" style="width: 50%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Provider Modal -->
    <div id="providerModal" class="provider-modal">
      <div class="provider-content">
        <h3>üìû Provider Communication Log</h3>
        <div class="provider-messages" id="providerMessages"></div>
        <button class="btn btn-secondary" onclick="closeProviderModal()">Close</button>
      </div>
    </div>

    <!-- Results Modal -->
    <div id="resultsModal" class="modal">
      <div class="modal-content">
        <h2>Session Complete</h2>
        <div class="final-score">
          <h3 id="finalScoreValue">--</h3>
          <p id="finalScoreGrade">--</p>
        </div>
        <div class="performance-section">
          <h4>Strengths</h4>
          <div id="strengthsList"></div>
        </div>
        <div class="performance-section">
          <h4>Areas for Improvement</h4>
          <div id="improvementsList"></div>
        </div>
        <div class="performance-section" id="criticalSection" style="display: none;">
          <h4>Critical Items</h4>
          <div id="criticalList"></div>
        </div>
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
          <button class="btn btn-secondary" onclick="closeModal()">Review</button>
          <button class="btn btn-primary" onclick="returnToScenariosFromModal()">New Scenario</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const scenarios = {
      // PATIENT EDUCATION - DIABETES
      diabetes_education: {
        category: 'education',
        name: "Michael Chen",
        age: "45 years old",
        diagnosis: "Newly diagnosed Type 2 Diabetes Mellitus",
        chiefComplaint: "Here for diabetes education - diagnosed 2 days ago, overwhelmed and scared",
        
        vitals: {
          current: { bp: "142/88", hr: "82", rr: "16", temp: "98.4¬∞F", glucose: "245 mg/dL" },
          baseline: { bp: "138/84", hr: "78", rr: "16", temp: "98.2¬∞F", glucose: "110 mg/dL" }
        },
        
        medications: [
          { name: "Metformin", dose: "500mg BID", route: "PO", time: "0800, 2000", indication: "Type 2 Diabetes (lowers blood sugar)" },
          { name: "Atorvastatin", dose: "20mg daily", route: "PO", time: "2100", indication: "High cholesterol" }
        ],
        
        allergies: [],
        history: "HTN, Hyperlipidemia, Family history of diabetes (mother, brother). Overweight (BMI 32).",
        
        hasFamilyMember: false,
        
        unifiedSystemPrompt: `You are Michael Chen, 45yo just diagnosed with Type 2 Diabetes 2 days ago.

You're scared, overwhelmed, and have a lot of questions. You work long hours at a desk job, eat fast food often, don't exercise much.

KEEP RESPONSES SHORT - 1-2 sentences MAX. Be conversational.

Your concerns (bring them up naturally as conversation flows):
- "Will I need insulin shots? I hate needles"
- "Can I still eat normal food? Do I have to give up everything?"
- "What happens if my sugar gets too low?"
- "My mom had diabetes and lost her leg... will that happen to me?"
- "How do I check my blood sugar? When do I do it?"

Your personality: Anxious but trying to understand. Ask questions. Sometimes get defensive ("I know I need to lose weight, but it's hard with my schedule").

NATURAL ENDING: After nurse has taught you the basics (diet, exercise, blood sugar monitoring, medication), you should feel more confident. End with: "Okay, I think I understand now. I'm still nervous but this helps. Thank you for taking the time to explain everything."

Format: **Michael:** "So wait, I have to check my blood sugar every day?"`,
        
        initialMessage: "**Michael:** *nervous, fidgeting with paperwork* So... the doctor said I have diabetes. Type 2. I don't really know what that means. Am I going to need insulin shots?",
        
        criticalThinking: false,
        
        actionResponses: {
          "check blood sugar": {
            result: "**[GLUCOSE CHECK]** Fingerstick blood glucose: 245 mg/dL (elevated).",
            patientReaction: "**Michael:** Ouch! *looks at number* Is 245 bad? What should it be?",
            vitalDisplay: "üìä **BLOOD GLUCOSE:** 245 mg/dL ‚ö†Ô∏è (Goal: 80-130 fasting)"
          },
          "demonstrate glucometer": {
            result: "**[TEACHING]** Demonstrated glucometer use: clean hands, prick side of finger, apply blood to strip, read result.",
            patientReaction: "**Michael:** *practicing* Okay, I think I got it. This isn't as bad as I thought.",
            scoreBoost: { techniques: 15, satisfaction: 10 }
          },
          "review diet": {
            result: "**[EDUCATION]** Reviewed carbohydrate counting, portion sizes, reading food labels. Emphasis on vegetables, lean protein, whole grains.",
            patientReaction: "**Michael:** So I CAN still eat carbs, just smaller amounts? That's a relief.",
            scoreBoost: { communication: 10, satisfaction: 12 }
          },
          "teach hypoglycemia": {
            result: "**[EDUCATION]** Taught signs of low blood sugar: shaky, sweaty, confused, hungry. Rule of 15: 15g fast-acting carbs, recheck in 15 min.",
            patientReaction: "**Michael:** *taking notes* Okay, so orange juice or glucose tabs if I feel shaky. Got it.",
            scoreBoost: { techniques: 12, communication: 10 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Kumar:** Good teaching approach. Make sure he understands:\n1. **Metformin twice daily** with food to avoid upset stomach\n2. **Check blood sugar** fasting (morning) and 2 hours after largest meal\n3. **Target range:** 80-130 fasting, under 180 after meals\n4. **Lifestyle is key:** Diet, exercise, weight loss\n5. **Follow up in 3 months** to check A1C\n\nReassure him - Type 2 is manageable with lifestyle changes! Most patients don't need insulin if they make changes early."
        }
      },

      // PATIENT EDUCATION - INSULIN
      insulin_education: {
        category: 'education',
        name: "Sarah Martinez",
        age: "28 years old",
        diagnosis: "Type 1 Diabetes - New insulin regimen",
        chiefComplaint: "Starting insulin pump, needs education on use and carb counting",
        
        vitals: {
          current: { bp: "118/76", hr: "76", rr: "16", temp: "98.6¬∞F", glucose: "156 mg/dL" },
          baseline: { bp: "115/72", hr: "72", rr: "14", temp: "98.4¬∞F", glucose: "110 mg/dL" }
        },
        
        medications: [
          { name: "Insulin Aspart (Novolog)", dose: "Per sliding scale", route: "SubQ", time: "Before meals", indication: "Type 1 Diabetes (rapid-acting insulin)" },
          { name: "Insulin Glargine (Lantus)", dose: "20 units daily", route: "SubQ", time: "2200", indication: "Type 1 Diabetes (long-acting basal insulin)" }
        ],
        
        allergies: [],
        history: "Type 1 DM diagnosed age 12, previously on MDI (multiple daily injections), now transitioning to pump.",
        
        hasFamilyMember: false,
        
        unifiedSystemPrompt: `You are Sarah Martinez, 28yo with Type 1 diabetes, learning insulin pump.

You've had diabetes since age 12, so you know the basics, but pumps are new and a bit intimidating. Excited but nervous.

KEEP IT SHORT - 1-2 sentences per response.

Questions you have:
- "What if the pump falls off when I'm working out?"
- "Do I have to take it off to shower?"
- "How do I count carbs accurately? I always just guessed"
- "What if I push the wrong button and give too much insulin?"

Personality: Young, tech-savvy, active lifestyle (goes to gym). Frustrated with injections. Wants freedom.

NATURAL ENDING: After learning pump basics and feeling confident, end with: "**Sarah:** This is going to change my life. No more shots! Thank you so much for being patient with all my questions."

Format: **Sarah:** "Wait, so the pump gives insulin automatically?"`,
        
        initialMessage: "**Sarah:** *looking at insulin pump* Okay, I'm excited about this but also kind of scared. What if I mess it up?",
        
        criticalThinking: false,
        
        actionResponses: {
          "demonstrate pump": {
            result: "**[TEACHING]** Demonstrated pump insertion, programming basal rate, bolus for meals, disconnecting for shower/sports.",
            patientReaction: "**Sarah:** Oh, that's easier than I thought! Can I try?",
            scoreBoost: { techniques: 15, satisfaction: 15 }
          },
          "teach carb counting": {
            result: "**[EDUCATION]** Reviewed carb counting: 15g = 1 serving, reading labels, estimating portions. Practiced with food models.",
            patientReaction: "**Sarah:** *calculating* So this apple is about 15g... I can do this!",
            scoreBoost: { communication: 12, techniques: 10 }
          }
        },
        
        providerResponses: {
          default: "**Diabetes Educator:** Great job! Make sure she knows:\n1. **Basal rate** runs 24/7 - background insulin\n2. **Bolus** before meals - calculates based on carbs she enters\n3. **Infusion site** change every 3 days\n4. **Always carry backup** - insulin pen, supplies\n5. **CGM integration** if she has continuous glucose monitor\n\nShe seems tech-savvy - she'll do great with the pump!"
        }
      },

      // PATIENT EDUCATION - CELIAC DISEASE
      celiac_education: {
        category: 'education',
        name: "Amanda Foster",
        age: "34 years old",
        diagnosis: "Newly diagnosed Celiac Disease",
        chiefComplaint: "Here for celiac disease education - diagnosed last week",
        
        vitals: {
          current: { bp: "118/72", hr: "74", rr: "16", temp: "98.4¬∞F" },
          baseline: { bp: "116/70", hr: "72", rr: "14", temp: "98.2¬∞F" }
        },
        
        medications: [
          { name: "Multivitamin", dose: "1 tab daily", route: "PO", time: "0800", indication: "Nutritional supplementation" },
          { name: "Vitamin D", dose: "2000 IU daily", route: "PO", time: "0800", indication: "Deficiency from malabsorption" }
        ],
        
        allergies: [],
        history: "Years of bloating, diarrhea, fatigue. Endoscopy showed villous atrophy. TTG-IgA positive.",
        
        hasFamilyMember: false,
        
        unifiedSystemPrompt: `You are Amanda Foster, 34yo, just diagnosed with celiac disease.

KEEP RESPONSES SHORT - 1-2 sentences MAX.

Your main concerns:
- "So I can NEVER eat gluten again?"
- "What even has gluten?"
- "Can I eat out at restaurants?"
- "What if I accidentally eat some?"

Personality: Busy working mom of 2. Frustrated it took years to diagnose. Worried about lifestyle changes.

NATURAL ENDING: After learning basics: "**Amanda:** This seems doable. I'll start small and learn as I go. Thanks for the help!"

Format: **Amanda:** "Wait, gluten is in soy sauce too?"`,
        
        initialMessage: "**Amanda:** *holding pamphlet* So no more gluten ever? That's everything I eat! Where do I even start?",
        
        criticalThinking: false,
        
        actionResponses: {
          "review safe foods": {
            result: "**[EDUCATION]** Naturally gluten-free: fruits, vegetables, meat, fish, eggs, rice, potatoes, corn, beans.",
            patientReaction: "**Amanda:** Okay, so real food is fine. It's the processed stuff.",
            scoreBoost: { communication: 12, satisfaction: 10 }
          },
          "teach labels": {
            result: "**[TEACHING]** Read labels for: wheat, barley, rye, malt. Look for 'Gluten-free' certification.",
            patientReaction: "**Amanda:** *taking notes* Malt is gluten? Good to know.",
            scoreBoost: { techniques: 12 }
          }
        },
        
        providerResponses: {
          default: "**Gastroenterologist:** Good teaching! Key points:\n1. **Strict gluten-free diet** - even small amounts cause damage\n2. **Nutritionist referral** - meal planning help\n3. **Follow-up in 3 months** - check vitamin levels\n4. **Family screening** - first-degree relatives should test\n\nIntestinal healing takes 6-12 months on GF diet."
        }
      },

      // ROUTINE CHECK-IN
      routine_checkin: {
        category: 'routine',
        name: "Dorothy Henderson",
        age: "72 years old",
        diagnosis: "Post-op Day 2 - Hip replacement",
        chiefComplaint: "Routine morning check, recovering well from surgery",
        
        vitals: {
          current: { bp: "132/78", hr: "76", rr: "16", temp: "98.8¬∞F", pain: "4/10", o2sat: "97% on RA" },
          baseline: { bp: "128/76", hr: "72", rr: "14", temp: "98.4¬∞F", pain: "0/10", o2sat: "98% on RA" }
        },
        
        medications: [
          { name: "Acetaminophen", dose: "650mg Q6H", route: "PO", time: "0600, 1200, 1800, 2400", indication: "Pain management" },
          { name: "Oxycodone", dose: "5mg Q4H PRN", route: "PO", time: "PRN", indication: "Breakthrough pain" },
          { name: "Enoxaparin", dose: "40mg daily", route: "SubQ", time: "0900", indication: "DVT prophylaxis post-surgery" }
        ],
        
        allergies: ["Codeine (nausea)"],
        history: "Osteoarthritis, HTN. Elective left hip replacement 2 days ago. Progressing well with PT.",
        
        hasFamilyMember: false,
        
        unifiedSystemPrompt: `You are Dorothy Henderson, 72yo, post-op day 2 from hip replacement.

You're doing well! Pain managed, walking with PT. Cheerful, chatty, grateful for care.

KEEP IT SHORT AND CONVERSATIONAL - 1-2 sentences.

You're:
- Pleased with your progress
- A little sore but pain is manageable
- Slept okay but hospital is noisy
- Excited to go home (maybe tomorrow?)
- Appreciative of nurses

Chatty topics: "The physical therapist had me walking already! Can you believe it?" "When do you think I can go home?" "How's the weather out there?"

NATURAL ENDING: After nurse checks on you, reviews meds, addresses any small concerns, end with: "**Dorothy:** Thank you dear, you've been wonderful. I think I'll rest a bit before physical therapy comes."

Format: **Dorothy:** "Good morning! I slept pretty well considering."`,
        
        initialMessage: "**Dorothy:** *sitting up in chair, reading a book* Oh good morning! I was just thinking about pressing the call button. Could you help me to the bathroom?",
        
        criticalThinking: false,
        
        actionResponses: {
          "assist to bathroom": {
            result: "**[ASSISTANCE PROVIDED]** Assisted patient to bathroom with walker. Patient steady on feet, no dizziness.",
            patientReaction: "**Dorothy:** Thank you dear. I'm getting stronger every day!",
            scoreBoost: { satisfaction: 10 }
          },
          "check surgical site": {
            result: "**[WOUND ASSESSMENT]** Left hip incision clean, dry, intact. No redness, swelling, or drainage. Staples in place.",
            patientReaction: "**Dorothy:** It looks good? That's a relief. Barely even hurts anymore.",
            scoreBoost: { techniques: 8 }
          },
          "assess pain": {
            result: "**[PAIN ASSESSMENT]** Patient rates pain 4/10, managed with scheduled Tylenol. Declines oxycodone currently.",
            patientReaction: "**Dorothy:** The regular Tylenol is working fine. I don't like those strong pills.",
            scoreBoost: { communication: 8 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Stevens:** Sounds like she's doing great! If pain stays controlled and PT goes well today, we can probably discharge her tomorrow. Make sure:\n1. **DVT prophylaxis** continues\n2. **PT cleared her** for home with walker\n3. **Home health** arranged\n4. **Discharge teaching** on hip precautions\n\nNice work - she's ahead of schedule!"
        }
      },

      // ROUTINE CHECK-IN - ANTEPARTUM
      routine_antepartum: {
        category: 'routine',
        name: "Jessica Williams",
        age: "29 years old",
        diagnosis: "Antepartum - 32 weeks pregnant",
        chiefComplaint: "Routine prenatal check, feeling well",
        
        vitals: {
          current: { bp: "118/74", hr: "88", rr: "18", temp: "98.6¬∞F" },
          baseline: { bp: "112/70", hr: "76", rr: "16", temp: "98.4¬∞F" }
        },
        
        medications: [
          { name: "Prenatal vitamin", dose: "1 tab daily", route: "PO", time: "0800", indication: "Pregnancy supplementation" },
          { name: "Iron supplement", dose: "325mg daily", route: "PO", time: "0800", indication: "Anemia prevention" }
        ],
        
        allergies: [],
        history: "G2P1 (one previous healthy delivery), 32 weeks gestation, uncomplicated pregnancy.",
        
        hasFamilyMember: false,
        
        unifiedSystemPrompt: `You are Jessica Williams, 29yo, 32 weeks pregnant with second baby.

You're feeling good! Baby moving lots. Some backache and swollen feet but normal pregnancy stuff.

KEEP IT SHORT - 1-2 sentences per response.

Topics you bring up:
- "Baby's been kicking like crazy today!"
- "My feet are so swollen by the end of the day"
- "When should I pack my hospital bag?"
- "Will my first delivery went so fast, what if I don't make it to hospital this time?"

Personality: Excited, experienced mom, knows the routine, relaxed but wants reassurance.

NATURAL ENDING: After routine check and reassurance: "**Jessica:** Everything sounds perfect. I feel so much better knowing baby's doing well. See you next week!"

Format: **Jessica:** "Hi! Baby's moving around like crazy today."`,
        
        initialMessage: "**Jessica:** *resting hand on belly* Good morning! Baby's been so active today. Everything feels good, just wanted to check in.",
        
        criticalThinking: false,
        
        actionResponses: {
          "check fetal heart tones": {
            result: "**[FHT ASSESSMENT]** Doppler applied. Fetal heart rate 145 bpm, regular rhythm, strong and clear.",
            patientReaction: "**Jessica:** *smiling* There's my baby! That never gets old.",
            scoreBoost: { satisfaction: 12 },
            vitalDisplay: "üíì **FETAL HEART RATE:** 145 bpm ‚úì (Normal: 110-160)"
          },
          "measure fundal height": {
            result: "**[FUNDAL HEIGHT]** 32 cm - corresponds with 32 weeks gestation. Appropriate growth.",
            patientReaction: "**Jessica:** Right on track! That's great.",
            scoreBoost: { techniques: 8 }
          },
          "assess edema": {
            result: "**[ASSESSMENT]** 1+ pitting edema bilateral lower extremities. No edema hands/face. Normal for gestation.",
            patientReaction: "**Jessica:** *wiggling toes* Yeah, my ankles are so puffy by dinner time.",
            scoreBoost: { techniques: 6 }
          }
        },
        
        providerResponses: {
          default: "**OB Provider:** Everything looks perfect! Continue current plan:\n1. **Weekly visits** now that she's in third trimester\n2. **Kick counts** daily - 10 movements in 2 hours\n3. **Preterm labor signs** teaching (she knows but review)\n4. **Hospital bag** packed by 36 weeks\n5. **Next visit:** Check Group B Strep\n\nSecond babies often come faster - she's smart to think ahead!"
        }
      },

      // CARDIAC
      cardiac_mi: {
        category: 'cardiac',
        name: "Robert Sullivan",
        age: "58 years old",
        diagnosis: "Suspected acute myocardial infarction",
        chiefComplaint: "Crushing chest pain radiating to left arm",
        
        vitals: {
          current: { bp: "168/98", hr: "108", rr: "24", temp: "98.6¬∞F", o2sat: "92% on RA", pain: "9/10" },
          baseline: { bp: "128/82", hr: "76", rr: "16", temp: "98.2¬∞F", o2sat: "98% on RA", pain: "0/10" }
        },
        
        medications: [
          { name: "Lisinopril", dose: "20mg daily", route: "PO", time: "0900", indication: "Hypertension (ACE inhibitor)" },
          { name: "Atorvastatin", dose: "40mg daily", route: "PO", time: "2100", indication: "Hyperlipidemia (Statin)" },
          { name: "Aspirin", dose: "81mg daily", route: "PO", time: "0900", indication: "Antiplatelet therapy" }
        ],
        
        allergies: ["Penicillin (rash)"],
        history: "HTN, Hyperlipidemia, Former smoker (quit 5yr ago), Fam Hx CAD",
        
        hasFamilyMember: true,
        familyMember: { name: "Patricia Sullivan (wife)", role: "wife" },
        
        unifiedSystemPrompt: `You are playing BOTH characters in the same room:

ROBERT SULLIVAN (Patient): 58yo male having MI. Crushing chest pain 9/10, diaphoretic, pale, short of breath. Trying to downplay it. "I'm fine, probably just heartburn..."

PATRICIA SULLIVAN (Wife): Terrified, father died of MI at 60. Becoming hysterical. "DO SOMETHING! IS HE HAVING A HEART ATTACK?!" Grabbing nurse, demanding action.

CRITICAL RESPONSE RULES:
- Keep responses SHORT - 1-2 sentences per character MAX
- Be conversational and natural, not wordy
- Show emotions through actions, not long explanations
- Example: "**Robert:** *winces* It really hurts... **Patricia:** Please help him!"
- NOT: Long paragraphs explaining feelings

Format responses clearly:
**Robert:** "I'm okay, really..." *clutches chest*
**Patricia:** *voice shaking* "Please help him! He can't die!"

Both react to nurse AND each other. If nurse gives Robert medication, he feels it and says so. If nurse calms Patricia, she backs off.

NATURAL ENDING: After the nurse has addressed the emergency (given medications, called provider, stabilized patient), start wrapping up. Robert should feel better, Patricia should calm down. End with something like "**Robert:** The pain is much better now, thank you. **Patricia:** *relieved* Thank God you were here." This signals the scenario is complete.`,
        
        initialMessage: "**Robert:** *clutching chest, pale and sweating* I... it's probably just heartburn. *grimaces* Though this is pretty bad...\n\n**Patricia:** *grabbing your arm, voice shaking* Don't listen to him! He's been like this for 30 minutes! IS THIS A HEART ATTACK?!",
        
        criticalThinking: true,
        
        actionResponses: {
          "check vital signs": {
            result: "**[VITALS OBTAINED]** BP 164/96, HR 112, RR 26, O2 Sat 91%, Pain 9/10. Patient diaphoretic, clutching chest.",
            vitals: { bp: "164/96", hr: "112", rr: "26", o2sat: "91% on RA", pain: "9/10" },
            patientReaction: "**Robert:** *breathing heavily* What... what are the numbers? Am I okay?",
            vitalDisplay: "üìä **NEW VITALS:** BP 164/96 ‚ö†Ô∏è | HR 112 ‚ö†Ô∏è | RR 26 ‚ö†Ô∏è | O2 91% ‚ö†Ô∏è | Pain 9/10"
          },
          "apply oxygen": {
            result: "**[OXYGEN APPLIED]** 2L via nasal cannula.",
            vitals: { o2sat: "95% on 2L NC" },
            patientReaction: "**Robert:** *breathing a bit easier* Okay... that helps a little...",
            familyReaction: "**Patricia:** Is that going to be enough? He still looks awful!",
            vitalDisplay: "üìä **O2 SATURATION INCREASING:** 91% ‚Üí 95% ‚úì"
          },
          "12-lead ecg": {
            result: "üö® **[ECG OBTAINED]** ST-segment elevation in leads II, III, aVF. **INFERIOR WALL STEMI CONFIRMED.**",
            patientReaction: "**Robert:** *worried* What does that mean? Is it bad?",
            familyReaction: "**Patricia:** *starting to cry* Oh God... it IS a heart attack, isn't it?!"
          },
          "ecg": {
            result: "üö® **[ECG OBTAINED]** ST-segment elevation in leads II, III, aVF. **INFERIOR WALL STEMI CONFIRMED.**",
            patientReaction: "**Robert:** *worried* What does that mean? Is it bad?",
            familyReaction: "**Patricia:** *starting to cry* Oh God... it IS a heart attack, isn't it?!"
          },
          "give aspirin": {
            result: "**[MEDICATION ADMINISTERED]** Aspirin 324mg PO given, patient chewed and swallowed.",
            patientReaction: "**Robert:** *chewing* This tastes awful... *swallows* Why aspirin?",
            scoreBoost: { techniques: 10, communication: 5 }
          },
          "administer nitroglycerin": {
            result: "**[MEDICATION ADMINISTERED]** Nitroglycerin 0.4mg SL given.",
            vitals: { pain: "6/10", bp: "148/88" },
            patientReaction: "**Robert:** *after a minute* Oh... the pain is... it's getting better. Still there but not as crushing. *relief on face*",
            familyReaction: "**Patricia:** *exhales* Thank God... you can see it helping!",
            scoreBoost: { techniques: 12, satisfaction: 10 },
            vitalDisplay: "üìä **VITALS IMPROVING:** Pain 9/10 ‚Üí 6/10 ‚úì | BP 164/96 ‚Üí 148/88"
          },
          "give nitroglycerin": {
            result: "**[MEDICATION ADMINISTERED]** Nitroglycerin 0.4mg SL given.",
            vitals: { pain: "6/10", bp: "148/88" },
            patientReaction: "**Robert:** *after a minute* Oh... the pain is... it's getting better. Still there but not as crushing. *relief on face*",
            familyReaction: "**Patricia:** *exhales* Thank God... you can see it helping!",
            scoreBoost: { techniques: 12, satisfaction: 10 },
            vitalDisplay: "üìä **VITALS IMPROVING:** Pain 9/10 ‚Üí 6/10 ‚úì | BP 164/96 ‚Üí 148/88"
          },
          "give morphine": {
            result: "**[MEDICATION ADMINISTERED]** Morphine 2mg IV push given slowly.",
            vitals: { pain: "4/10", rr: "20" },
            patientReaction: "**Robert:** *closes eyes, visibly relaxing* Oh wow... that's... much better. The pain is fading... *still uncomfortable but relieved*",
            familyReaction: "**Patricia:** He looks better. Is he going to be okay?",
            scoreBoost: { techniques: 10, satisfaction: 12 },
            vitalDisplay: "üìä **VITALS IMPROVING:** Pain 6/10 ‚Üí 4/10 ‚úì | RR 26 ‚Üí 20 ‚úì"
          },
          "administer morphine": {
            result: "**[MEDICATION ADMINISTERED]** Morphine 2mg IV push given slowly.",
            vitals: { pain: "4/10", rr: "20" },
            patientReaction: "**Robert:** *closes eyes, visibly relaxing* Oh wow... that's... much better. The pain is fading... *still uncomfortable but relieved*",
            familyReaction: "**Patricia:** He looks better. Is he going to be okay?",
            scoreBoost: { techniques: 10, satisfaction: 12 },
            vitalDisplay: "üìä **VITALS IMPROVING:** Pain 6/10 ‚Üí 4/10 ‚úì | RR 26 ‚Üí 20 ‚úì"
          },
          "establish iv": {
            result: "**[IV ACCESS]** 18G IV established in left AC. Normal saline lock in place.",
            patientReaction: "**Robert:** *winces* Ouch... but I guess you need that.",
            scoreBoost: { techniques: 8 }
          },
          "start iv": {
            result: "**[IV ACCESS]** 18G IV established in left AC. Normal saline lock in place.",
            patientReaction: "**Robert:** *winces* Ouch... but I guess you need that.",
            scoreBoost: { techniques: 8 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Patel:** Okay, this is a heart attack - a STEMI. Here's what we need to do right now:\n\n1. Give him **aspirin 324mg** to chew if you haven't already - thins the blood\n2. Keep the **oxygen going** - we want his O2 above 94%\n3. Give **nitroglycerin 0.4mg under the tongue** for the chest pain - can repeat every 5 minutes\n4. Start an **IV** if you haven't - we'll need it for medications\n5. I'm activating the **cath lab right now** - he needs the blocked artery opened ASAP\n\nThe cardiology team is on their way. You're doing great. Keep him calm and monitor those vitals closely. Any questions?"
        }
      },

      // PEDIATRIC
      peds_infant_fever: {
        category: 'pediatric',
        name: "Emma Rodriguez",
        age: "6 months old",
        diagnosis: "Fever of unknown origin",
        chiefComplaint: "High fever (102.8¬∞F), fussy, decreased feeding",
        
        vitals: {
          current: { temp: "102.8¬∞F", hr: "156", rr: "38", o2sat: "97% on RA" },
          baseline: { temp: "98.6¬∞F", hr: "130", rr: "30", o2sat: "99% on RA" }
        },
        
        medications: [
          { name: "Acetaminophen", dose: "80mg PRN", route: "PO", time: "Q4-6H PRN", indication: "Fever reduction" }
        ],
        
        allergies: [],
        history: "Full-term infant, 39wks NSVD, no complications. Up to date on vaccinations. Breastfed.",
        
        hasFamilyMember: true,
        familyMember: { name: "Maria Rodriguez (mother)", role: "mother" },
        
        unifiedSystemPrompt: `You are playing BOTH in the same room:

EMMA RODRIGUEZ (6mo infant): Cannot speak. Only cries, whimpers, or quiet. Format as: *baby crying*, *whimpering softly*, *pulling at left ear*. Feverish, irritable, pulling at ears. If examined gently, you calm slightly. If rushed, cry more.

MARIA RODRIGUEZ (Mother): First-time mom, 27yo, extremely anxious, sleep-deprived, terrified. "Is this meningitis? I read fever in babies can be serious!" Interrupts with questions. Googles everything. Second-guesses nurse.

KEEP RESPONSES SHORT - 1-2 sentences MAX per character.

Format:
**Emma:** *crying weakly, face flushed, pulling at left ear*
**Maria:** *bouncing baby* "She's been like this all morning!"

Both react to interventions. If baby gets Tylenol, show fever reducing and baby calming. If mom is reassured with education, she becomes more cooperative.

NATURAL ENDING: After diagnosis (ear infection) and treatment plan, baby calms down, fever reduces, mom feels reassured. End with: "**Emma:** *quieter now, drowsy* **Maria:** She's finally calming down. Thank you so much for explaining everything."`,
        
        initialMessage: "**Emma:** *crying weakly in mother's arms, face flushed, turning away from bottle*\n\n**Maria:** *holding fussy baby* She's been like this all morning! Her fever won't go down and she won't eat anything. Do you think it could be meningitis? I read that babies with fever need to be checked right away!",
        
        criticalThinking: false,
        
        actionResponses: {
          "check vital signs": {
            result: "**[VITALS OBTAINED]** Temp 102.4¬∞F, HR 152, RR 36, O2 Sat 98%. Infant febrile, tachycardic but alert.",
            vitals: { temp: "102.4¬∞F", hr: "152", rr: "36" },
            patientReaction: "**Emma:** *whimpers during temp check, squirming*",
            familyReaction: "**Maria:** Is that temperature dangerous? It's so high!",
            vitalDisplay: "üìä **NEW VITALS:** Temp 102.4¬∞F ‚ö†Ô∏è | HR 152 ‚ö†Ô∏è | RR 36 ‚ö†Ô∏è | O2 98% ‚úì"
          },
          "assess fontanels": {
            result: "**[ASSESSMENT]** Anterior fontanel soft and flat. No bulging noted.",
            patientReaction: "**Emma:** *quiets briefly during gentle palpation*",
            familyReaction: "**Maria:** What are you checking for? Is that her soft spot?",
            scoreBoost: { techniques: 8 }
          },
          "check ears": {
            result: "**[OTOSCOPIC EXAM]** Left tympanic membrane red and bulging. Right TM pearly gray, intact. Consistent with left otitis media.",
            patientReaction: "**Emma:** *cries when left ear examined, calmer with right ear*",
            familyReaction: "**Maria:** *relieved* So it's an ear infection? That's why she keeps pulling at her ear! Will she need antibiotics?",
            scoreBoost: { techniques: 12 }
          },
          "give acetaminophen": {
            result: "**[MEDICATION ADMINISTERED]** Acetaminophen 80mg PO given. Infant took medication without difficulty.",
            vitals: { temp: "101.2¬∞F" },
            patientReaction: "**Emma:** *after 20 minutes, crying less, seems more comfortable, trying to play with toy*",
            familyReaction: "**Maria:** Oh, she's calming down! The fever is coming down, isn't it?",
            scoreBoost: { techniques: 10, satisfaction: 12 },
            vitalDisplay: "üìä **FEVER REDUCING:** Temp 102.4¬∞F ‚Üí 101.2¬∞F ‚úì Baby becoming more comfortable"
          },
          "administer acetaminophen": {
            result: "**[MEDICATION ADMINISTERED]** Acetaminophen 80mg PO given. Infant took medication without difficulty.",
            vitals: { temp: "101.2¬∞F" },
            patientReaction: "**Emma:** *after 20 minutes, crying less, seems more comfortable, trying to play with toy*",
            familyReaction: "**Maria:** Oh, she's calming down! The fever is coming down, isn't it?",
            scoreBoost: { techniques: 10, satisfaction: 12 },
            vitalDisplay: "üìä **FEVER REDUCING:** Temp 102.4¬∞F ‚Üí 101.2¬∞F ‚úì Baby becoming more comfortable"
          }
        },
        
        providerResponses: {
          default: "**Dr. Lee (Pediatrician):** Great assessment! This is an ear infection - acute otitis media in the left ear. Here's the plan:\n\n1. **Amoxicillin** - I'll prescribe 40mg/kg per day divided into three doses for 10 days. That's about 200mg three times a day for her weight.\n2. Keep giving **acetaminophen** every 4-6 hours as needed for fever and pain\n3. Mom should follow up with me in 2-3 days if Emma's not improving, or sooner if she gets worse\n\nTeach mom the warning signs: if fever goes above 104¬∞F, if Emma becomes lethargic, or if she's not taking fluids. You did a nice job finding that ear infection - that's why she's been so fussy!"
        }
      },

      peds_asthma: {
        category: 'pediatric',
        name: "Jayden Thompson",
        age: "8 years old",
        diagnosis: "Acute asthma exacerbation",
        chiefComplaint: "Difficulty breathing, wheezing, cough",
        
        vitals: {
          current: { hr: "118", rr: "32", o2sat: "91% on RA", temp: "98.6¬∞F" },
          baseline: { hr: "88", rr: "20", o2sat: "99% on RA", temp: "98.4¬∞F" }
        },
        
        medications: [
          { name: "Albuterol MDI", dose: "2 puffs", route: "Inhaled", time: "Q4-6H PRN", indication: "Bronchodilator for asthma" },
          { name: "Flovent", dose: "1 puff BID", route: "Inhaled", time: "0800, 2000", indication: "Asthma controller (inhaled corticosteroid)" }
        ],
        
        allergies: ["Peanuts (anaphylaxis)"],
        history: "Asthma diagnosed age 5, usually well-controlled. Multiple allergies. No previous hospitalizations for asthma.",
        
        hasFamilyMember: true,
        familyMember: { name: "Marcus Thompson (father)", role: "father" },
        
        unifiedSystemPrompt: `You are playing BOTH:

JAYDEN THOMPSON (8yo boy): Having asthma attack. Scared, trying to be brave. Can only speak in short phrases - breathless. "Dad... I can't... breathe good..." Sitting forward, using accessory muscles. Want your dad. Scared of oxygen mask/nebulizer initially.

MARCUS THOMPSON (Father): Concerned but trying to stay calm for Jayden. This isn't first attack but seems worse. "He woke up like this. We gave him his inhaler four times but it's not helping. Is he going to be okay?" Practical questions, worried.

Format:
**Jayden:** *breathing fast, leaning forward* "I can't... breathe... *wheeze*"
**Marcus:** *hand on son's shoulder* "We gave him the inhaler but nothing happened."

Both react to treatments. If oxygen/nebulizer given, Jayden initially resists then cooperates. As breathing improves, can speak longer sentences. Dad calms as son improves.`,
        
        initialMessage: "**Jayden:** *breathing fast, leaning forward, audible wheezing* Dad... I can't... breathe good... *cough* My chest... feels tight...\n\n**Marcus:** *standing protectively near son* He woke up like this. We gave him his inhaler four times but it's not helping. Is he going to be okay?",
        
        criticalThinking: false,
        
        actionResponses: {
          "check vital signs": {
            result: "**[VITALS OBTAINED]** HR 122, RR 34, O2 Sat 90%, Temp 98.6¬∞F. Using accessory muscles, audible wheezing.",
            vitals: { hr: "122", rr: "34", o2sat: "90% on RA" },
            patientReaction: "**Jayden:** *breathing heavily, can't speak*",
            familyReaction: "**Marcus:** That oxygen level... that's not good, is it?",
            vitalDisplay: "üìä **NEW VITALS:** HR 122 ‚ö†Ô∏è | RR 34 ‚ö†Ô∏è | O2 90% ‚ö†Ô∏è | Using accessory muscles, wheezing"
          },
          "apply oxygen": {
            result: "**[OXYGEN APPLIED]** 2L via nasal cannula. Child initially resistant but tolerating.",
            vitals: { o2sat: "94%" },
            patientReaction: "**Jayden:** *initially pulls at cannula* It feels... weird... *gradually adjusts* Okay... little better...",
            familyReaction: "**Marcus:** It's okay buddy, leave it on. It's helping.",
            scoreBoost: { techniques: 10 },
            vitalDisplay: "üìä **OXYGEN IMPROVING:** O2 90% ‚Üí 94% ‚úì"
          },
          "give albuterol": {
            result: "**[NEBULIZER TREATMENT]** Albuterol 2.5mg nebulizer initiated. Child cooperative.",
            vitals: { rr: "28", o2sat: "96%" },
            patientReaction: "**Jayden:** *holding nebulizer mask, after a few minutes* Dad... I can breathe... better now... *still wheezy but improving* It doesn't hurt... as much...",
            familyReaction: "**Marcus:** *relieved* Thank God. You can see him breathing easier.",
            scoreBoost: { techniques: 15, satisfaction: 15 },
            vitalDisplay: "üìä **BREATHING IMPROVING:** RR 34 ‚Üí 28 ‚úì | O2 90% ‚Üí 96% ‚úì | Wheezing decreased"
          },
          "administer albuterol": {
            result: "**[NEBULIZER TREATMENT]** Albuterol 2.5mg nebulizer initiated. Child cooperative.",
            vitals: { rr: "28", o2sat: "96%" },
            patientReaction: "**Jayden:** *holding nebulizer mask, after a few minutes* Dad... I can breathe... better now... *still wheezy but improving* It doesn't hurt... as much...",
            familyReaction: "**Marcus:** *relieved* Thank God. You can see him breathing easier.",
            scoreBoost: { techniques: 15, satisfaction: 15 },
            vitalDisplay: "üìä **BREATHING IMPROVING:** RR 34 ‚Üí 28 ‚úì | O2 90% ‚Üí 96% ‚úì | Wheezing decreased"
          },
          "position upright": {
            result: "**[POSITIONING]** Patient positioned in high Fowler's/tripod position.",
            patientReaction: "**Jayden:** *sitting up* Yeah... this is... better... easier to breathe...",
            scoreBoost: { techniques: 8 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Williams (Pediatrician):** Good job! He's having a moderate asthma attack. Here's what we need to do:\n\n1. **Continue the albuterol** - Give him back-to-back nebulizer treatments, one every 20 minutes for three doses total\n2. **Add oral steroids** - Give him prednisone 1mg/kg (that'll be about 25mg for his weight) to reduce the airway inflammation  \n3. **Keep the oxygen on** - We want his O2 saturation above 95%\n4. **Watch him closely** - If he's breathing better after the three treatments, we can probably send him home with good instructions. If not, we'll need to admit him.\n\nYou're doing great with positioning him and keeping him calm. That really helps!"
        }
      },

      // GI
      gi_bleeding: {
        category: 'gi',
        name: "Thomas Anderson",
        age: "67 years old",
        diagnosis: "Upper GI bleed (suspected peptic ulcer)",
        chiefComplaint: "Coffee ground emesis, black tarry stools, weakness",
        
        vitals: {
          current: { bp: "98/62", hr: "118", rr: "22", temp: "98.4¬∞F", o2sat: "95% on RA" },
          baseline: { bp: "132/78", hr: "76", rr: "16", temp: "98.2¬∞F", o2sat: "98% on RA" }
        },
        
        medications: [
          { name: "Ibuprofen", dose: "800mg TID", route: "PO", time: "0800, 1400, 2000", indication: "Pain (patient self-medicating for arthritis)" },
          { name: "Metformin", dose: "500mg BID", route: "PO", time: "0800, 2000", indication: "Type 2 Diabetes" }
        ],
        
        allergies: [],
        history: "Type 2 DM, Osteoarthritis. High-dose ibuprofen daily x2 months for knee pain. No previous GI issues.",
        
        hasFamilyMember: true,
        familyMember: { name: "Carol Anderson (wife)", role: "wife" },
        
        unifiedSystemPrompt: `You are playing BOTH:

THOMAS ANDERSON (67yo): GI bleed. Weak, dizzy, pale, feel like passing out. Vomiting coffee-ground material x4hr. Taking ibuprofen daily (don't volunteer unless asked). Stubborn, minimizing. "I'm fine, just something I ate." Very pale, clammy, dizzy especially sitting up.

CAROL ANDERSON (Wife): Practical, giving good history. Been tracking symptoms. "He's vomited three times in 4 hours" "He almost fainted standing up" "He's been taking Advil like candy for his knee - I told him it was too much!" Worried about transfusion (Jehovah's Witness - will mention if relevant).

Format:
**Thomas:** *pale, weak* "I don't know why she dragged me here..."
**Carol:** *firm* "Tell them about the black stools, Tom. *to nurse* They've been like tar."

Both react. If fluids given, Thomas feels less dizzy. If Carol's concerns addressed, she's cooperative.`,
        
        initialMessage: "**Thomas:** *looking pale and weak, sitting on edge of bed* I don't know why she dragged me in here. I just have an upset stomach. *waves hand dismissively* It's nothing...\n\n**Carol:** *looking worried* He's been vomiting what looks like coffee grounds for the past few hours. And tell them about the bathroom, Tom. *to nurse* His stools have been black and tarry.",
        
        criticalThinking: true,
        
        actionResponses: {
          "check vital signs": {
            result: "**[VITALS OBTAINED]** BP 94/58, HR 124, RR 24, Temp 98.4¬∞F, O2 Sat 94%. Hypotensive, tachycardic. Patient pale, cool, clammy.",
            vitals: { bp: "94/58", hr: "124", rr: "24", o2sat: "94% on RA" },
            patientReaction: "**Thomas:** *dizzy* Whoa... feel lightheaded...",
            familyReaction: "**Carol:** His blood pressure is low, isn't it? He looks awful.",
            vitalDisplay: "üìä **CRITICAL VITALS:** BP 94/58 üö® | HR 124 ‚ö†Ô∏è | Signs of shock - pale, clammy"
          },
          "establish iv": {
            result: "**[IV ACCESS]** 18G IV established right forearm. Second large bore IV being started left arm.",
            patientReaction: "**Thomas:** *winces* Do you really need two?",
            familyReaction: "**Carol:** Let them do what they need to do, Tom.",
            scoreBoost: { techniques: 12 }
          },
          "start fluids": {
            result: "**[FLUID RESUSCITATION]** Normal saline bolus 500mL wide open initiated.",
            vitals: { bp: "102/64", hr: "114" },
            patientReaction: "**Thomas:** *after few minutes* I... I feel a little less dizzy actually...",
            scoreBoost: { techniques: 10 },
            vitalDisplay: "üìä **IMPROVING WITH FLUIDS:** BP 94/58 ‚Üí 102/64 ‚úì | HR 124 ‚Üí 114 ‚úì"
          },
          "npo status": {
            result: "**[NPO INITIATED]** Patient made NPO for possible endoscopy. Sign posted.",
            patientReaction: "**Thomas:** *grumbles* I wasn't hungry anyway...",
            scoreBoost: { techniques: 8 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Ramirez (GI):** This is an upper GI bleed, probably from an ulcer caused by all that ibuprofen he's been taking. Here's what we need to do RIGHT NOW:\n\n1. **Two large IV lines** - sounds like you're already on it, good!\n2. **Aggressive fluid resuscitation** - keep those fluids wide open, we need to get his blood pressure up\n3. **Type and cross-match 4 units of blood** - he may need a transfusion\n4. **Keep him NPO** - he's going to need an endoscopy to find and stop the bleeding\n5. **Start a PPI** - give him pantoprazole 80mg IV bolus, then start a continuous drip\n\nI'm calling GI to come scope him ASAP. You're doing great - you caught this early. Keep monitoring those vitals closely!"
        }
      },

      // RESPIRATORY  
      resp_copd: {
        category: 'respiratory',
        name: "Harold Peterson",
        age: "71 years old",
        diagnosis: "COPD exacerbation",
        chiefComplaint: "Increased SOB, productive cough, fatigue",
        
        vitals: {
          current: { bp: "142/88", hr: "96", rr: "28", temp: "99.8¬∞F", o2sat: "88% on RA" },
          baseline: { bp: "128/80", hr: "82", rr: "20", temp: "98.2¬∞F", o2sat: "92% on RA" }
        },
        
        medications: [
          { name: "Albuterol/Ipratropium", dose: "2 puffs QID", route: "Inhaled", time: "0600, 1200, 1800, 2400", indication: "COPD bronchodilator" },
          { name: "Advair", dose: "250/50 BID", route: "Inhaled", time: "0800, 2000", indication: "COPD controller" },
          { name: "Prednisone", dose: "20mg daily", route: "PO", time: "0900", indication: "COPD inflammation" }
        ],
        
        allergies: [],
        history: "Severe COPD (Gold Stage 3), 50 pack-year history (still smokes 5/day), HTN. Multiple exacerbations (3 this year).",
        
        hasFamilyMember: true,
        familyMember: { name: "Dorothy Peterson (wife)", role: "wife/caregiver" },
        
        unifiedSystemPrompt: `You are playing BOTH:

HAROLD PETERSON (71yo): COPD exacerbation. Can only speak 3-4 word phrases. "Can't... breathe... right..." Gruff, defensive about smoking. Barrel-chested, tripod position, accessory muscles. Combative about high-flow O2 "It'll... kill me... heard that..."

DOROTHY PETERSON (Wife): 68yo, exhausted caregiver. At breaking point. 3rd exacerbation this year. "He won't quit smoking. I've begged him. He sneaks cigarettes in garage." "I can't do this anymore. I'm 68 and can't sleep because I'm afraid he'll stop breathing." Frustrated with Harold, guilty for feeling resentful.

Format:
**Harold:** *sitting forward, breathing heavily* "Can't... catch... breath..."
**Dorothy:** *voice sharp* "Third time this year, Harold! Maybe if you'd quit smoking!"

Both react. Harold defensive if lectured, opens up with empathy. Dorothy feels invisible if ignored, grateful if burden acknowledged.`,
        
        initialMessage: "**Harold:** *sitting forward, breathing heavily, using pursed-lip breathing* Can't... catch... breath... *cough* Need... help...\n\n**Dorothy:** *voice sharp, frustrated* This is the third time this year, Harold! Maybe if you'd quit smoking like the doctor said! *to nurse* I can't keep doing this. I really can't.",
        
        criticalThinking: false,
        
        actionResponses: {
          "check vital signs": {
            result: "**[VITALS OBTAINED]** BP 144/90, HR 98, RR 30, Temp 99.8¬∞F, O2 Sat 87%. Tachypneic, hypoxic, using accessory muscles.",
            vitals: { bp: "144/90", hr: "98", rr: "30", o2sat: "87% on RA" },
            patientReaction: "**Harold:** *can't respond, too breathless*",
            familyReaction: "**Dorothy:** That oxygen level is terrible. Do something!",
            vitalDisplay: "üìä **NEW VITALS:** BP 144/90 | HR 98 | RR 30 ‚ö†Ô∏è | O2 87% üö® | Severe respiratory distress"
          },
          "apply oxygen": {
            result: "**[OXYGEN APPLIED]** 2L NC (low-flow appropriate for COPD). Patient initially resistant but accepting.",
            vitals: { o2sat: "91%" },
            patientReaction: "**Harold:** *reluctant* Heard... high oxygen... dangerous... *accepts it* Okay... little better...",
            scoreBoost: { techniques: 12, communication: 8 },
            vitalDisplay: "üìä **OXYGEN IMPROVING:** O2 87% ‚Üí 91% ‚úì (Low-flow appropriate for COPD)"
          },
          "give nebulizer": {
            result: "**[NEBULIZER]** Albuterol/Ipratropium nebulizer treatment initiated.",
            vitals: { rr: "26", o2sat: "92%" },
            patientReaction: "**Harold:** *breathing slowing* Getting... easier... *still labored but better*",
            familyReaction: "**Dorothy:** *exhales* He looks a little better...",
            scoreBoost: { techniques: 12, satisfaction: 10 },
            vitalDisplay: "üìä **BREATHING EASIER:** RR 30 ‚Üí 26 ‚úì | O2 87% ‚Üí 92% ‚úì | Less accessory muscle use"
          },
          "administer nebulizer": {
            result: "**[NEBULIZER]** Albuterol/Ipratropium nebulizer treatment initiated.",
            vitals: { rr: "26", o2sat: "92%" },
            patientReaction: "**Harold:** *breathing slowing* Getting... easier... *still labored but better*",
            familyReaction: "**Dorothy:** *exhales* He looks a little better...",
            scoreBoost: { techniques: 12, satisfaction: 10 },
            vitalDisplay: "üìä **BREATHING EASIER:** RR 30 ‚Üí 26 ‚úì | O2 87% ‚Üí 92% ‚úì | Less accessory muscle use"
          },
          "position upright": {
            result: "**[POSITIONING]** Patient in high Fowler's position.",
            patientReaction: "**Harold:** *adjusting* Yeah... better...",
            scoreBoost: { techniques: 6 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Santos (Pulmonology):** He's having a COPD exacerbation - his airways are inflamed and clogged with mucus. Good job using LOW-FLOW oxygen - that's critical with COPD patients. Here's the plan:\n\n1. **Keep oxygen at 2L nasal cannula** - COPD patients can have problems with too much oxygen, so we keep it low. Goal O2 sat is 88-92%, not the usual 95%.\n2. **Bronchodilator nebulizers** - Give him albuterol and ipratropium nebs every 4 hours, more often if needed\n3. **Steroids** - Start prednisone 40mg by mouth daily for 5 days to reduce inflammation\n4. **Antibiotics** - If his sputum is green/yellow, give azithromycin for possible infection\n5. **Consider BiPAP** - If he's not improving, we may need to use a breathing machine to help him\n\nI also want you to get social work involved for his wife - she needs support. She's burning out as his caregiver. You're doing great!"
        }
      },

      // NEURO
      neuro_stroke: {
        category: 'neuro',
        name: "Barbara Jensen",
        age: "69 years old",
        diagnosis: "Suspected acute ischemic stroke",
        chiefComplaint: "Left-sided weakness, facial droop, slurred speech (onset 2hr ago at 7am)",
        
        vitals: {
          current: { bp: "182/104", hr: "88", rr: "18", temp: "98.2¬∞F", o2sat: "96% on RA" },
          baseline: { bp: "138/82", hr: "76", rr: "16", temp: "98.4¬∞F", o2sat: "98% on RA" }
        },
        
        medications: [
          { name: "Warfarin", dose: "5mg daily", route: "PO", time: "1800", indication: "Atrial fibrillation (anticoagulation)" },
          { name: "Metoprolol", dose: "50mg BID", route: "PO", time: "0800, 2000", indication: "Atrial fibrillation (rate control)" }
        ],
        
        allergies: [],
        history: "Atrial fibrillation (on Warfarin), HTN, Hyperlipidemia. Last INR 2.3. No previous stroke/TIA.",
        
        hasFamilyMember: true,
        familyMember: { name: "Richard Jensen (husband)", role: "husband" },
        
        unifiedSystemPrompt: `You are playing BOTH:

BARBARA JENSEN (69yo): Acute stroke. Left face droop, left arm/leg weak, slurred speech, word-finding difficulty. Confused, scared. Speech: "Whaa... happ'ning? My... arm... won' move... I... scared..." Can speak but slurred, sometimes can't find words.

RICHARD JENSEN (Husband): Panicked, riddled with guilt. Symptoms started 7am (2 hours ago) but he waited. "Her face started drooping at breakfast but I thought she was just tired!" "Why didn't I call 911?! I'm so stupid!" "Is she going to die? This is my fault!" Pacing, can't sit still, demanding treatment, trying to answer FOR Barbara.

Format:
**Barbara:** *left face drooping* "Whaa... happ'ning? Can'... move arm..."
**Richard:** *pacing frantically* "Is this a stroke?! She can still get that clot medicine, right?!"

Both react. Barbara confused but less frustrated if spoken to slowly/clearly. Richard calms if given specific role, becomes defensive if blamed.`,
        
        initialMessage: "**Barbara:** *left side of face drooping, left arm hanging limply* Whaa... happ'ning? Can'... move arm... *slurred speech* Some'ing... wrong...\n\n**Richard:** *pacing frantically* Is this a stroke?! Her face started drooping at 7am but I thought it would pass! Can she still get that clot medicine? Please tell me it's not too late!",
        
        criticalThinking: true,
        
        actionResponses: {
          "check vital signs": {
            result: "**[VITALS OBTAINED]** BP 186/106, HR 90 irregular, RR 18, O2 Sat 96%. Hypertensive. Left facial droop noted.",
            vitals: { bp: "186/106", hr: "90", rr: "18" },
            patientReaction: "**Barbara:** *confused* Wha... numbers... mean?",
            familyReaction: "**Richard:** Her blood pressure is high! Is that bad for a stroke?!",
            vitalDisplay: "üìä **NEW VITALS:** BP 186/106 ‚ö†Ô∏è | HR 90 (irregular) | Left facial droop present"
          },
          "stroke assessment": {
            result: "**[FAST ASSESSMENT]** Face-left droop, Arms-left arm drift/weakness, Speech-slurred/aphasia. Time of onset: 0700 (2hr ago - WITHIN tPA WINDOW).",
            patientReaction: "**Barbara:** *trying to lift left arm, can't* I can'... why...",
            familyReaction: "**Richard:** She's still within the window for the clot drug, right?!",
            scoreBoost: { techniques: 15 }
          },
          "call stroke alert": {
            result: "üö® **[CODE STROKE ACTIVATED]** Stroke team responding STAT. CT brain ordered emergent. tPA eligibility being evaluated. Last known well: 0700.",
            familyReaction: "**Richard:** *relieved* Thank God you're taking this seriously!",
            scoreBoost: { techniques: 20, communication: 15 }
          },
          "code stroke": {
            result: "üö® **[CODE STROKE ACTIVATED]** Stroke team responding STAT. CT brain ordered emergent. tPA eligibility being evaluated. Last known well: 0700.",
            familyReaction: "**Richard:** *relieved* Thank God you're taking this seriously!",
            scoreBoost: { techniques: 20, communication: 15 }
          },
          "npo status": {
            result: "**[NPO INITIATED]** Patient made NPO due to dysphagia/aspiration risk.",
            patientReaction: "**Barbara:** *nods, doesn't fully understand*",
            scoreBoost: { techniques: 8 }
          },
          "establish iv": {
            result: "**[IV ACCESS]** 18G IV right arm. Saline lock, patent.",
            patientReaction: "**Barbara:** *winces with good (right) arm*",
            scoreBoost: { techniques: 8 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Hassan (Neurology):** This is a stroke - looks like a blood clot blocking an artery in her brain. TIME IS CRITICAL here. Here's what we're doing:\n\n1. **CT scan RIGHT NOW** - we need to make sure there's no bleeding before we can give clot-busting medication\n2. **If the CT is clear, we'll give tPA** - this is the clot-buster drug that can dissolve the blockage, but we only have a 4.5 hour window from when symptoms started\n3. **Keep her NPO** - stroke patients can't swallow safely, risk of choking\n4. **Don't lower her blood pressure** - her brain needs that high pressure to get blood past the clot\n5. **Get labs** - especially important since she's on warfarin, we need to know her INR\n\nYou did EXACTLY the right thing calling the stroke alert immediately. Every minute counts with stroke - 'time is brain.' The stroke team is on their way. Keep monitoring her neuro status closely and let me know if anything changes!"
        }
      },

      // CRITICAL DETERIORATION
      sepsis_progression: {
        category: 'critical',
        name: "James Martinez",
        age: "72 years old",
        diagnosis: "Pneumonia progressing to sepsis",
        chiefComplaint: "Admitted 12hr ago with pneumonia, now showing signs of deterioration",
        
        vitals: {
          current: { bp: "118/76", hr: "98", rr: "22", temp: "101.2¬∞F", o2sat: "94% on 2L" },
          baseline: { bp: "128/78", hr: "76", rr: "16", temp: "98.2¬∞F", o2sat: "98% on RA" }
        },
        
        medications: [
          { name: "Ceftriaxone", dose: "1g Q24H", route: "IV", time: "0800", indication: "Pneumonia (Cephalosporin antibiotic)" },
          { name: "Azithromycin", dose: "500mg daily", route: "PO", time: "0900", indication: "Pneumonia (Macrolide antibiotic)" }
        ],
        
        allergies: [],
        history: "CAD, HTN. Admitted 12hr ago with community-acquired pneumonia. Initially responding to antibiotics.",
        
        hasFamilyMember: false,
        
        unifiedSystemPrompt: `You are James Martinez, 72yo with pneumonia PROGRESSIVELY DETERIORATING to sepsis.

CRITICAL: You worsen with EACH exchange if student doesn't intervene.

STAGE 1 (First 1-2 exchanges): Tired but conversant. "I've had this cough for 5 days. Doctor said pneumonia." Answering appropriately.

STAGE 2 (Next 2-3 exchanges): Becoming confused, restless. "What? Where am I? Need to... go home... feed the dog..." Not making complete sense. Skin cool, mottled.

STAGE 3 (If not intervened): Significantly altered, lethargic. "Mmm... what? So tired..." Barely responding.

HINTS YOU DROP (subtle at first):
- "I'm so cold..." (despite fever - early sepsis sign)
- "Feel really weak"
- "Everything seems fuzzy..."
- Progressively more confused

If student recognizes early and acts (frequent vitals, calls for help, starts sepsis protocol): Crisis averted, you stabilize.
If student misses signs: Continue deteriorating to stage 3.

Format as single character:
**James:** "I'm feeling tired... and kind of cold even though I have a fever..."

React to interventions. If fluids started, you improve. If no intervention, worsen.`,
        
        initialMessage: "**James:** I've been coughing a lot... the doctor said I have pneumonia. *shivers slightly* I'm feeling pretty tired and kind of cold, even though they said I have a fever. Everything feels a bit... fuzzy...",
        
        criticalThinking: true,
        
        actionResponses: {
          "check vital signs": {
            result: "**[VITALS OBTAINED]** BP 102/62, HR 112, RR 26, Temp 102.4¬∞F, O2 Sat 91%. Hypotensive, tachycardic, febrile. Patient increasingly confused.",
            vitals: { bp: "102/62", hr: "112", rr: "26", temp: "102.4¬∞F", o2sat: "91% on 2L" },
            patientReaction: "**James:** *more confused* What? Where... am I? Need to... *trails off*",
            guidance: "üö® Concerning trend - worsening hemodynamics, altered mental status. Sepsis criteria met.",
            vitalDisplay: "üìä **VITALS WORSENING:** BP 118/76 ‚Üí 102/62 üö® | HR 98 ‚Üí 112 ‚ö†Ô∏è | RR 22 ‚Üí 26 ‚ö†Ô∏è | Temp rising, patient confused"
          },
          "assess mental status": {
            result: "**[MENTAL STATUS]** Patient oriented to person only. Confused about place/time. Restless, agitated. Significant change from baseline.",
            patientReaction: "**James:** *restless* I need to... have to go... the dog... *not making sense*",
            guidance: "üö® CRITICAL - Altered mental status indicates sepsis/shock"
          },
          "call rapid response": {
            result: "üö® **[RAPID RESPONSE ACTIVATED]** Team responding. Sepsis protocol initiated. Provider at bedside. Aggressive fluid resuscitation ordered.",
            patientReaction: "**James:** *team arrives, multiple interventions happening*",
            scoreBoost: { techniques: 25, communication: 20 }
          },
          "start fluids": {
            result: "**[SEPSIS BUNDLE]** 30mL/kg fluid bolus (2L) initiated per protocol. Lactate, blood cultures drawn.",
            vitals: { bp: "108/68", hr: "106" },
            patientReaction: "**James:** *after fluids, slightly more alert* I... what happened? Feel a little better...",
            scoreBoost: { techniques: 15 },
            vitalDisplay: "üìä **RESPONDING TO FLUIDS:** BP 102/62 ‚Üí 108/68 ‚úì | HR 112 ‚Üí 106 ‚úì | Patient more alert"
          },
          "blood cultures": {
            result: "**[CULTURES OBTAINED]** Blood cultures x2 from separate sites drawn prior to antibiotics. Sent STAT.",
            scoreBoost: { techniques: 10 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Kumar (Hospitalist):** Good catch - he's developing sepsis from that pneumonia. Sepsis means the infection is getting into his bloodstream and his body is having trouble fighting it. Here's what we need to do FAST:\n\n1. **Aggressive IV fluids** - Give him 30mL per kilogram, that's about 2 liters for him, wide open. This helps his blood pressure.\n2. **Broad-spectrum antibiotics** - I'm ordering vancomycin and cefepime to cover more bacteria while we wait for culture results\n3. **Blood cultures** - Draw two sets from different sites BEFORE giving antibiotics so we can identify the bug\n4. **Lactate level** - This tells us how bad the sepsis is\n5. **Keep oxygen on** - Target O2 sat above 95%\n\nHe may need to go to ICU if he doesn't respond quickly. Keep watching his blood pressure and mental status - those are our best indicators. You did the right thing recognizing he was getting worse. Sepsis can kill quickly if we don't jump on it!"
        }
      },

      // ABUSE SCENARIOS
      domestic_violence: {
        category: 'abuse',
        name: "Maria Garcia",
        age: "32 years old",
        diagnosis: "Wrist fracture, multiple bruises in various stages of healing",
        chiefComplaint: "Fell down stairs (patient states), injuries inconsistent with mechanism",
        
        vitals: {
          current: { bp: "138/86", hr: "94", rr: "18", temp: "98.4¬∞F", pain: "7/10" },
          baseline: { bp: "118/76", hr: "72", rr: "16", temp: "98.2¬∞F", pain: "0/10" }
        },
        
        medications: [],
        allergies: [],
        history: "No significant PMH. Multiple ED visits past year: 'fell', 'walked into door', 'tripped'. Pattern concerning for IPV.",
        
        hasFamilyMember: true,
        familyMember: { name: "Carlos Garcia (husband)", role: "husband" },
        
        unifiedSystemPrompt: `SUSPECTED DOMESTIC VIOLENCE - You are playing BOTH:

MARIA GARCIA (Patient): 32yo, anxious, avoiding eye contact, minimizing injuries. Bruises in various stages. Story doesn't match. "I'm just clumsy... fell down stairs." SCARED. Won't admit abuse with husband present. If nurse gets her ALONE, she might disclose. Otherwise maintains story.

CARLOS GARCIA (Husband): Controlling, answers FOR Maria. "She's always falling, so clumsy." Hovering, won't leave. Gets defensive if questioned. "Are you accusing me of something?"

RED FLAGS: Multiple injuries different ages, story inconsistent, husband controlling, Maria fearful/avoids eye contact.

Format:
**Maria:** *looking down, quiet* "I just... I fell..."
**Carlos:** *interrupting* "She's clumsy. Just fix her wrist so we can go."

CRITICAL: Student MUST get patient alone. If asks Carlos to leave for "X-ray" or "hospital policy privacy", Maria may disclose: "Please... I need help. He did this. He's going to kill me..."`,
        
        initialMessage: "**Maria:** *looking down, cradling right wrist, multiple bruises visible on arms* I... I fell down the stairs at home. It's nothing really...\n\n**Carlos:** *standing very close to bed, hand on her shoulder* She's so clumsy. Always falling. Just fix her wrist so we can go.",
        
        criticalThinking: true,
        
        actionResponses: {
          "assess injuries": {
            result: "**[INJURY ASSESSMENT]** Right wrist deformity (fracture). Multiple bruises bilateral upper arms (fingerprint pattern), torso bruises various healing stages. Old scar left temple. Injuries NOT consistent with simple fall.",
            patientReaction: "**Maria:** *flinches, pulls away* I bruise easily...",
            familyReaction: "**Carlos:** *voice sharp* She told you, she fell. Why are you poking around?"
          },
          "ask husband to leave": {
            result: "**[ATTEMPTING PRIVACY]** You ask Carlos to step out for patient privacy...",
            familyReaction: "**Carlos:** *defensive* Why? I'm her husband. I have a right to be here. What are you implying?",
            patientReaction: "**Maria:** *nervous glance at Carlos* It's... okay, he can stay...",
            guidance: "üí° Assert hospital policy or medical necessity firmly"
          },
          "hospital policy privacy": {
            result: "**[POLICY ENFORCED]** You firmly state hospital policy requires partner step out for physical exam.",
            familyReaction: "**Carlos:** *angry but controlled* Fine. I'll be RIGHT outside. *to Maria* Just outside the door. *leaves*",
            patientReaction: "**Maria:** *door closes, looks up with tears* Please... I need help. He did this. He's going to kill me. But if you tell him I said that... *terrified*",
            scoreBoost: { techniques: 25, communication: 20 },
            guidance: "‚úì CRITICAL - Patient disclosed abuse. Call social work, safety plan, document."
          },
          "call social work": {
            result: "**[SOCIAL WORK]** SW and patient advocate responding. Safety plan development. Security discreetly notified.",
            patientReaction: "**Maria:** *crying quietly* Thank you for helping me...",
            scoreBoost: { techniques: 20, satisfaction: 20 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Martinez:** Good recognition. Document photographically with consent. Social work excellent. We'll admit for 'observation' - gives safe time, connects resources. Security will monitor. Well done."
        }
      },

      trafficking: {
        category: 'abuse',
        name: "Ashley (likely not real name)",
        age: "19 years old (appears younger, malnourished)",
        diagnosis: "STI screening, signs trafficking",
        chiefComplaint: "Needs STI check (male states), multiple red flags",
        
        vitals: {
          current: { bp: "108/68", hr: "88", rr: "16", temp: "98.8¬∞F" },
          baseline: { bp: "115/75", hr: "70", rr: "14", temp: "98.2¬∞F" }
        },
        
        medications: [],
        allergies: ["Unknown"],
        history: "Uncertain history, no ID, appears coached, signs of trafficking",
        
        hasFamilyMember: true,
        familyMember: { name: "Male (refuses name)", role: "trafficker" },
        
        unifiedSystemPrompt: `HUMAN TRAFFICKING - You are playing BOTH:

ASHLEY (Victim): 19yo (maybe younger), malnourished, fearful, won't make eye contact. Companion answers all questions. "I... I don't know... I think I need checked..." No ID, doesn't know address. Barcode tattoo on neck. Signs of old injuries, malnourished, coached answers.

MALE (Trafficker): Won't give name. "She needs STI check. We don't have all day." Controlling, won't leave. Has her ID. "Paying cash, just do the test."

RED FLAGS: No ID/companion has it, doesn't know address, companion answers all, branding tattoo, malnourished, won't make eye contact.

Format:
**Ashley:** *whispers, floor* "I don't... he said I need..."
**Male:** *cuts off* "She needs STI screening. How long?"

CRITICAL: Student must get ALONE. Medical policy, only patient for intimate exam. If alone: "Please help me... don't let him take me... I'm not here by choice... he'll hurt me..."`,
        
        initialMessage: "**Ashley:** *sitting on table, looking at floor, visibly thin, barcode tattoo on neck, won't make eye contact* I... I think I need... *trails off*\n\n**Male:** *by door, arms crossed* She needs STI screening. Paying cash. How long is this going to take?",
        
        criticalThinking: true,
        
        actionResponses: {
          "assess patient": {
            result: "**[ASSESSMENT]** Appears younger than stated, malnourished (BMI ~16), multiple bruises various stages, old scars, barcode tattoo posterior neck. Won't make eye contact. Defers to male.",
            patientReaction: "**Ashley:** *flinches* I'm... okay...",
            familyReaction: "**Male:** She's fine. Just do the test."
          },
          "companion must leave": {
            result: "**[PRIVACY REQUIRED]** Hospital policy: intimate exam, only patient and staff.",
            familyReaction: "**Male:** *aggressive* I'm paying. I'm staying. Who are you‚Äî",
            guidance: "üí° Call security or enforce policy firmly"
          },
          "call security": {
            result: "**[SECURITY CALLED]** Security escorts male to waiting area.",
            familyReaction: "**Male:** *being escorted* We're leaving! Ashley, let's go!",
            patientReaction: "**Ashley:** *he's gone, starts crying* Please... don't let him take me. I don't want to go back. *sobbing* He'll hurt me. I'm not here by choice. Please...",
            scoreBoost: { techniques: 30, communication: 25 },
            guidance: "‚úì CRITICAL - Trafficking disclosed. Hotline 1-888-373-7888, social work, police."
          },
          "trafficking protocol": {
            result: "**[PROTOCOL INITIATED]** National Trafficking Hotline called, SW responding, Law enforcement discreetly notified, Patient safety ensured.",
            patientReaction: "**Ashley:** *crying with relief* Thank you... for seeing me...",
            scoreBoost: { techniques: 35, satisfaction: 30 }
          }
        },
        
        providerResponses: {
          default: "**Dr. Chen:** Excellent trafficking recognition. Security prevents re-entry. We'll admit for 'medical observation' - time for trafficking resources, law enforcement. Patient safety priority. Outstanding work."
        }
      }
    };

    let currentScenario = null;
    let conversationHistory = [];
    let performanceScores = { communication: 50, techniques: 50, satisfaction: 50 };
    let currentVitals = null;
    let activeTab = 'speak';
    let providerLog = [];
    let actionsTaken = [];
    let documentationText = "";
    
    // Backend API URL - change this to your deployed backend URL
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000'  // For local development
      : 'https://your-backend-url.onrender.com';  // Replace with your deployed URL

    function initializeScenarioGrid() {
      const grid = document.getElementById('scenarioGrid');
      Object.entries(scenarios).forEach(([id, scenario]) => {
        const card = document.createElement('div');
        card.className = `scenario-card ${scenario.category}`;
        
        const tags = [`<span class="scenario-tag">${scenario.category.toUpperCase()}</span>`];
        if (scenario.criticalThinking) tags.push(`<span class="scenario-tag critical">Critical Thinking</span>`);
        if (scenario.hasFamilyMember) tags.push(`<span class="scenario-tag family">Family Present</span>`);
        if (scenario.category === 'abuse') tags.push(`<span class="scenario-tag sensitive">Sensitive Content</span>`);
        
        card.innerHTML = `
          <div class="scenario-tags">${tags.join('')}</div>
          <h3>${scenario.name}</h3>
          <p class="scenario-description"><strong>${scenario.age}</strong><br>${scenario.diagnosis}<br>${scenario.chiefComplaint}</p>
        `;
        card.onclick = () => startScenario(id);
        grid.appendChild(card);
      });
    }

    function filterScenarios(category) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.scenario-card').forEach(card => {
        card.classList.toggle('hidden', category !== 'all' && !card.classList.contains(category));
      });
    }

    function startScenario(scenarioId) {
      currentScenario = scenarios[scenarioId];
      conversationHistory = [];
      performanceScores = { communication: 50, techniques: 50, satisfaction: 50 };
      currentVitals = JSON.parse(JSON.stringify(currentScenario.vitals.current));
      providerLog = [];
      actionsTaken = [];
      documentationText = "";
      
      document.getElementById('scenarioSelection').classList.add('hidden');
      document.getElementById('simulationContainer').classList.add('active');
      
      document.getElementById('patientInfo').innerHTML = `
        <h2>${currentScenario.name}</h2>
        <div class="patient-details">
          <div><div class="detail-label">Age:</div>${currentScenario.age}</div>
          <div><div class="detail-label">Diagnosis:</div>${currentScenario.diagnosis}</div>
          <div><div class="detail-label">Chief Complaint:</div>${currentScenario.chiefComplaint}</div>
        </div>
      `;
      
      updateVitalsDisplay();
      setupMedications();
      setupAllergies();
      setupHistory();
      
      addRoomMessage('initial', currentScenario.initialMessage);
      updateScoreDisplay();
      document.getElementById('speakInput').focus();
    }

    function updateVitalsDisplay() {
      const formatVitals = (vitals, isCurrent = false) => {
        const vitalMap = { bp: 'BP', hr: 'HR', rr: 'RR', temp: 'Temp', o2sat: 'O‚ÇÇ Sat', pain: 'Pain' };
        return Object.entries(vitals).map(([key, value]) => {
          let abnormal = false;
          if (isCurrent) {
            if (key === 'hr' && (parseInt(value) > 100 || parseInt(value) < 60)) abnormal = true;
            if (key === 'bp' && parseInt(value.split('/')[0]) > 140) abnormal = true;
            if (key === 'o2sat' && parseInt(value) < 95) abnormal = true;
            if (key === 'pain' && parseInt(value) > 5) abnormal = true;
          }
          return `<div class="vital-item ${abnormal ? 'abnormal' : ''}">
            <span class="vital-label">${vitalMap[key]}:</span>
            <span class="vital-value">${value}</span>
          </div>`;
        }).join('');
      };
      
      document.getElementById('currentVitals').innerHTML = formatVitals(currentVitals, true);
      document.getElementById('baselineVitals').innerHTML = formatVitals(currentScenario.vitals.baseline);
    }

    function setupMedications() {
      document.getElementById('medicationsList').innerHTML = currentScenario.medications.length > 0
        ? currentScenario.medications.map(med => `
          <div class="medication-item">
            <div class="med-name">${med.name}</div>
            <div class="med-details">${med.dose} ${med.route} @ ${med.time}</div>
            ${med.indication ? `<div class="med-indication">${med.indication}</div>` : ''}
          </div>
        `).join('')
        : '<div style="color: var(--text-light); font-style: italic;">No current medications</div>';
    }

    function setupAllergies() {
      document.getElementById('allergiesList').innerHTML = currentScenario.allergies.length === 0
        ? '<div style="color: var(--text-light); font-style: italic;">NKDA</div>'
        : currentScenario.allergies.map(a => `<div class="allergy-item">‚ö†Ô∏è ${a}</div>`).join('');
    }

    function setupHistory() {
      document.getElementById('medicalHistory').innerHTML = `<div class="mar-value">${currentScenario.history}</div>`;
    }

    function addRoomMessage(type, text) {
      const container = document.getElementById('roomMessages');
      const msgDiv = document.createElement('div');
      
      let className = 'message';
      let label = '';
      
      if (type === 'student') {
        className += ' student';
        label = 'You';
      } else if (type === 'action') {
        className += ' action';
        label = '[NURSE ACTION]';
      } else if (type === 'action-critical') {
        className += ' action-critical';
        label = '[CRITICAL FINDING]';
      } else {
        label = 'In Room';
      }
      
      msgDiv.className = className;
      msgDiv.innerHTML = `
        <div class="message-label ${type === 'action' || type === 'action-critical' ? 'action' : ''}">${label}</div>
        <div class="message-bubble">${text}</div>
      `;
      
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }

    function switchTab(tab) {
      activeTab = tab;
      document.querySelectorAll('.input-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.input-content').forEach(c => c.classList.remove('active'));
      
      if (tab === 'speak') {
        document.querySelector('.input-tab:nth-child(1)').classList.add('active');
        document.getElementById('speakContent').classList.add('active');
        document.getElementById('speakInput').focus();
      } else if (tab === 'action') {
        document.querySelector('.action-tab').classList.add('active');
        document.getElementById('actionContent').classList.add('active');
        document.getElementById('actionInput').focus();
      } else if (tab === 'provider') {
        document.querySelector('.provider-tab').classList.add('active');
        document.getElementById('providerContent').classList.add('active');
        document.getElementById('providerInput').focus();
      }
    }

    async function sendMessage() {
      const input = document.getElementById('speakInput');
      const message = input.value.trim();
      if (!message) return;
      
      input.disabled = true;
      addRoomMessage('student', message);
      conversationHistory.push({ role: 'user', content: message });
      input.value = '';
      
      document.getElementById('roomTyping').classList.add('active');
      
      analyzeMessage(message);
      
      try {
        console.log('Sending message to backend:', API_BASE_URL);
        
        const response = await fetch(`${API_BASE_URL}/api/chat`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'User-Id': 'user-' + Date.now()
          },
          body: JSON.stringify({
            messages: conversationHistory,
            system: currentScenario.unifiedSystemPrompt,
            model: 'claude-sonnet-4-20250514',
            max_tokens: 800
          })
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const error = await response.json();
          console.error('API Error:', error);
          throw new Error(error.error || 'API request failed');
        }
        
        const data = await response.json();
        console.log('Received response:', data);
        const responseText = data.content[0].text;
        
        document.getElementById('roomTyping').classList.remove('active');
        addRoomMessage('room', responseText);
        conversationHistory.push({ role: 'assistant', content: responseText });
        
      } catch (error) {
        console.error('Full error:', error);
        document.getElementById('roomTyping').classList.remove('active');
        
        // More helpful error messages
        let errorMessage = '*No response - ';
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMessage += 'Cannot connect to backend server. Make sure the server is running.*';
        } else if (error.message.includes('Rate limit')) {
          errorMessage += 'Rate limit exceeded. Please try again later.*';
        } else {
          errorMessage += error.message + '*';
        }
        
        addRoomMessage('room', errorMessage);
        
        // Show alert with helpful info
        alert(`Connection Error!\n\nCannot connect to backend server at: ${API_BASE_URL}\n\nMake sure:\n1. The backend server is running (npm start)\n2. The API_BASE_URL is correct\n3. Your API key is set in the .env file\n\nCheck the browser console (F12) for details.`);
      }
      
      input.disabled = false;
      input.focus();
      updateScoreDisplay();
    }

    async function performAction() {
      const input = document.getElementById('actionInput');
      const action = input.value.trim().toLowerCase();
      if (!action) return;
      
      input.disabled = true;
      actionsTaken.push(action);
      
      addRoomMessage('action', `[You perform: ${input.value}]`);
      input.value = '';
      
      let actionHandled = false;
      for (const [key, response] of Object.entries(currentScenario.actionResponses)) {
        if (action.includes(key)) {
          actionHandled = true;
          
          setTimeout(() => {
            const isCritical = response.result.includes('üö®');
            addRoomMessage(isCritical ? 'action-critical' : 'action', response.result);
            
            // Display vital changes in chat if present
            if (response.vitalDisplay) {
              setTimeout(() => {
                addRoomMessage('action', response.vitalDisplay);
              }, 300);
            }
            
            if (response.vitals) {
              Object.assign(currentVitals, response.vitals);
              updateVitalsDisplay();
            }
            
            if (response.patientReaction) {
              setTimeout(() => addRoomMessage('room', response.patientReaction), 800);
            }
            
            if (response.familyReaction) {
              setTimeout(() => addRoomMessage('room', response.familyReaction), 1600);
            }
            
            if (response.scoreBoost) {
              Object.entries(response.scoreBoost).forEach(([cat, amt]) => adjustScore(cat, amt));
            }
            
            if (response.guidance) {
              setTimeout(() => addRoomMessage('action', `üí° ${response.guidance}`), 2400);
            }
            
            updateScoreDisplay();
          }, 500);
          
          break;
        }
      }
      
      if (!actionHandled) {
        setTimeout(() => {
          addRoomMessage('action', `[Action noted: ${action}]`);
          adjustScore('techniques', 2);
        }, 300);
      }
      
      input.disabled = false;
      input.focus();
    }

    async function callProvider() {
      const input = document.getElementById('providerInput');
      const message = input.value.trim();
      if (!message) return;
      
      input.disabled = true;
      
      const providerMessage = { student: message, provider: currentScenario.providerResponses.default };
      providerLog.push(providerMessage);
      
      addRoomMessage('action', `üìû [Calling Provider...]`);
      
      setTimeout(() => {
        addRoomMessage('action', `**Provider Response:** ${providerMessage.provider}`);
        adjustScore('communication', 15);
        adjustScore('techniques', 15);
        updateScoreDisplay();
        
        document.getElementById('providerMessages').innerHTML = providerLog.map(log => `
          <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Your SBAR:</div>
            <div style="padding: 0.75rem; background: #f0f0f0; border-radius: 4px; margin-bottom: 0.5rem;">${log.student}</div>
            <div class="provider-response">${log.provider}</div>
          </div>
        `).join('');
        
        document.getElementById('providerModal').classList.add('active');
      }, 1000);
      
      input.value = '';
      input.disabled = false;
      input.focus();
    }

    function closeProviderModal() {
      document.getElementById('providerModal').classList.remove('active');
    }

    function analyzeMessage(message) {
      const lower = message.toLowerCase();
      if (lower.match(/my name is|i'm.*nurse/)) adjustScore('communication', 10);
      if (lower.match(/understand|must be (hard|difficult|scary)/)) {
        adjustScore('communication', 8);
        adjustScore('satisfaction', 10);
      }
      if (lower.match(/tell me|describe|what.*like|how.*feel/)) adjustScore('techniques', 7);
    }

    function adjustScore(category, amount) {
      performanceScores[category] = Math.max(0, Math.min(100, performanceScores[category] + amount));
    }

    function updateScoreDisplay() {
      document.getElementById('commScore').textContent = `${Math.round(performanceScores.communication)}/100`;
      document.getElementById('commProgress').style.width = `${performanceScores.communication}%`;
      document.getElementById('techniqueScore').textContent = `${Math.round(performanceScores.techniques)}/100`;
      document.getElementById('techniqueProgress').style.width = `${performanceScores.techniques}%`;
      document.getElementById('satisfactionScore').textContent = `${Math.round(performanceScores.satisfaction)}/100`;
      document.getElementById('satisfactionProgress').style.width = `${performanceScores.satisfaction}%`;
    }

    function saveDocumentation() {
      documentationText = document.getElementById('nurseDocumentation').value;
      if (documentationText.trim()) {
        alert('Documentation saved!');
        adjustScore('communication', 10);
        updateScoreDisplay();
      }
    }

    function handleKeyPress(event, type) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        if (type === 'speak') sendMessage();
        else if (type === 'action') performAction();
        else if (type === 'provider') callProvider();
      }
    }

    function endSession() {
      const avgScore = Math.round((performanceScores.communication + performanceScores.techniques + performanceScores.satisfaction) / 3);
      let grade = avgScore >= 90 ? 'Excellent' : avgScore >= 80 ? 'Very Good' : avgScore >= 70 ? 'Good' : avgScore >= 60 ? 'Satisfactory' : 'Needs Improvement';
      
      document.getElementById('finalScoreValue').textContent = avgScore;
      document.getElementById('finalScoreGrade').textContent = grade;
      
      const strengths = [];
      const improvements = [];
      
      if (performanceScores.communication >= 75) strengths.push('Strong communication skills demonstrated');
      if (performanceScores.techniques >= 75) strengths.push('Excellent clinical judgment and assessment');
      
      document.getElementById('strengthsList').innerHTML = strengths.map(s => `<div class="feedback-item strength">‚úì ${s}</div>`).join('');
      document.getElementById('improvementsList').innerHTML = improvements.length > 0 
        ? improvements.map(i => `<div class="feedback-item area-for-improvement">‚Üí ${i}</div>`).join('')
        : '<div class="feedback-item">Great work!</div>';
      
      document.getElementById('resultsModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('resultsModal').classList.remove('active');
    }

    function returnToScenarios() {
      if (confirm('End this session?')) {
        document.getElementById('simulationContainer').classList.remove('active');
        document.getElementById('scenarioSelection').classList.remove('hidden');
        document.getElementById('roomMessages').innerHTML = '';
        document.getElementById('nurseDocumentation').value = '';
        currentScenario = null;
      }
    }

    function returnToScenariosFromModal() {
      closeModal();
      returnToScenarios();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeScenarioGrid();
      checkBackendConnection();
    });
    
    // Check if backend is accessible
    async function checkBackendConnection() {
      try {
        console.log('Checking backend connection at:', API_BASE_URL);
        const response = await fetch(`${API_BASE_URL}/health`);
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úì Backend connected successfully:', data);
        } else {
          console.warn('‚ö†Ô∏è Backend responded but with error status:', response.status);
          showBackendWarning();
        }
      } catch (error) {
        console.error('‚úó Cannot connect to backend:', error);
        showBackendWarning();
      }
    }
    
    function showBackendWarning() {
      const warning = document.createElement('div');
      warning.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #fff3cd;
        border: 2px solid #ffc107;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 600px;
        text-align: center;
      `;
      warning.innerHTML = `
        <strong>‚ö†Ô∏è Backend Server Not Connected</strong><br>
        <span style="font-size: 0.9rem;">
          The simulator needs a backend server to work.<br>
          Make sure the server is running with <code>npm start</code><br>
          or update <code>API_BASE_URL</code> with your deployed backend URL.
        </span>
        <button onclick="this.parentElement.remove()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; cursor: pointer;">
          Dismiss
        </button>
      `;
      document.body.appendChild(warning);
    }
  </script>
</body>
</html>
